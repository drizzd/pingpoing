<html>
 <head>
  <script type="application/javascript">
var target_fps = 60.0;
var status_interval = 2000;

var canvas = null;
var prev_time = null;
var fps_start = null;
var ball = { x: 75, y: 75 };
var panel = { x: 15, y: 60, w: 10, h: 100 };
var v = { x: 100, y: 175 };

function init() {
	var d = new Date();
	prev_time = d.getTime();

	canvas = document.getElementById("canvas");

	if (!canvas.getContext) {
		alert('canvas.getContext failed');
		return;
	}

	update();
}

function vec_copy(v) {
	return { x: v.x, y: v.y };
}

function vec_add(a, v) {
	b = vec_copy(a);

	b.x += v.x;
	b.y += v.y;

	return b;
}

function vec_scal(t, v) {
	var w = vec_copy(v);

	w.x *= t;
	w.y *= t;

	return w;
}

var cnt = 0;
function check_status(time) {
	cnt += 1;
	if (status_interval*Math.floor(time/status_interval) > prev_time) {
		console.log("ball:", ball.x.toFixed(0), ball.y.toFixed(0));

		var t = (time - fps_start)/1000;
		if (fps_start && t > 0) {
			var fps = cnt/t;
			console.log("fps: " + fps.toFixed(1));
		}

		cnt = 0;
		fps_start = time;
	}
}

function limit1(x, w) {
	if (x < 0) {
		x = 0;
	} else if (x > w) {
		x = w;
	}

	return x;
}

function limit(v, x, y) {
	return { x: limit1(v.x, x), y: limit1(v.y, y) };
}

function reflect1(x, w) {
	if (x < 0) {
		x = -x;
	} else if (x > w) {
		x = w - (x - w);
	}

	return x;
}

function reflect(a, x, y) {
	var b = vec_copy(a);

	b.x = reflect1(b.x, x);
	b.y = reflect1(b.y, y);

	return limit(b, x, y);
}

function update() {
	var d = new Date();
	var time = d.getTime()

	var t = (time - prev_time)/1000.0;

	var w = vec_scal(t, v);
	ball = vec_add(ball, w);
	if (ball.x < 0 || ball.x > canvas.width) {
		v.x = -v.x;
	}
	if (ball.y < 0 || ball.y > canvas.height) {
		v.y = -v.y;
	}
	ball = reflect(ball, canvas.width, canvas.height);

	draw();

	check_status(time);

	prev_time = time;
	setTimeout(update, 1000/target_fps);
}

function drawDisc(ctx, r) {
	ctx.ctrokeStyle = 'grey';
	ctx.beginPath();
	ctx.arc(0,0,r,0,Math.PI*2);
	ctx.fill();
}

function drawBall(ctx, r) {
	var radgrad = ctx.createRadialGradient(-3,-2,1,0,0,r);
	radgrad.addColorStop(0, '#e0e0e0');
	radgrad.addColorStop(0.9, '#686868');
	radgrad.addColorStop(1, 'rgba(1,159,98,0)');

	// draw shapes
	ctx.fillStyle = radgrad;
	ctx.fillRect(-r,-r,2*r,2*r);
}

function drawPanel(ctx, w, h)
{
	ctx.strokeStyle = 'black';
	ctx.lineWidth = w;
	ctx.lineCap = 'round';
	ctx.beginPath();
	ctx.moveTo(0,0);
	ctx.lineTo(0,h);
	ctx.stroke()
}

function draw() {
	var ctx = canvas.getContext("2d");
	var r = 10;

	ctx.save();
	ctx.setTransform(1, 0, 0, 1, 0, 0);
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	ctx.restore();

	ctx.save();
	ctx.translate(panel.x, panel.y);
	ctx.translate(-panel.w/2, -panel.h/2);
	drawPanel(ctx, panel.w, panel.h);
	ctx.restore();
	
	ctx.save();
	ctx.translate(ball.x,ball.y)
	drawBall(ctx, r);
	//drawDisc(ctx, r);
	ctx.restore();
}
  </script>
 </head>
 <style type="text/css">
	 canvas { border: 1px solid black; }
 </style>
 <body onload="init();">
   <canvas id="canvas" border="1" width="500" height="200">fallback content</canvas>
 </body>
</html>
